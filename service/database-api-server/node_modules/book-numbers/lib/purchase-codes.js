'use strict';

const qtoolsGen = require('qtools');
const qtools = new qtoolsGen(module);
console.error(`HELLO FROM: ${__filename}`);

//START OF moduleFunction() ============================================================

const moduleFunction = function(args = {}) {
	const { config } = args;
	const codes = qtools.convertNumericObjectToArray(config.codes);
	const makeBookNumber = (purchaseCode, callback) => {
		const tmp = codes.filter(
			item => purchaseCode.toLowerCase() == item.code.toLowerCase()
		);

		const thisCodeObj = codes.filter(
			item => purchaseCode.toLowerCase() == item.code.toLowerCase()
		)[0];

		const expiration = new Date(thisCodeObj.codeExpirationDate);
		const today = new Date();

		if (expiration > today) {
			const newNumber = `${purchaseCode}_${qtools
				.newGuid()
				.replace(/\W/g, '')}`;

			callback('', newNumber);
			return;
		}

		callback(`The purchase code ${purchaseCode} has expired.`);
	};

	const isPurchaseCode = purchaseNumber => {
		const existingCodes = codes.map(item => item.code.toLowerCase());

		return existingCodes.includes(purchaseNumber.toLowerCase());
	};

	return { makeBookNumber, isPurchaseCode };
};

//END OF moduleFunction() ============================================================

module.exports = moduleFunction;
//module.exports = new moduleFunction();
//moduleFunction().workingFunction().qtDump();

