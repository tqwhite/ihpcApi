'use strict';
const qtoolsGen = require('qtools');
const qtools = new qtoolsGen(module);
//const crypt=require('crypto');

//START OF moduleFunction() ============================================================

var moduleFunction = function(args) {

	qtools.validateProperties({
		subject: args || {},
		targetScope: this, //will add listed items to targetScope
		propList: [
			{
				name: 'config',
				optional: false
			},
			{
				name: 'router',
				optional: false
			},
			{
				name: 'mongoose',
				optional: false
			},
			{
				name: 'permissionMaster',
				optional: false
			},
			{
				name: 'initCallback',
				optional: false
			}
		]
	});

	//LOCAL VARIABLES ====================================
	const mongoose = this.mongoose;

	//LOCAL FUNCTIONS ====================================

	//METHODS AND PROPERTIES ====================================

	this.shutdown = (message, callback) => {
		console.log(`shutting down ${__dirname}`);
		callback('', message);
	}

	const getList = (criteria, callback) => {
		User.find(criteria, callback);

	}

	//API ENDPOINTS ====================================

	let route = new RegExp('user$');
	this.permissionMaster.addRoute(route, 'admin editor');

	this.router.get(route, (req, res, next) => {
		getList({}, (err, users) => {
			if (err) {
				next({
					code: '500',
					message: 'Database access problem (users.get())'
				});
			} else {
				res.json({
					token: this.permissionMaster.updateToken(req),
					data: users
				});
			}
		});

	});

	//INITIALIZATION ====================================

	const userSchema = mongoose.Schema({
		first: String,
		last: String,
		username: String,
		pwhash: String,
		role: String,
		debugDataVersion: String
	});

	userSchema.methods.speak = function() {
		const greeting = this.name
			? "Meow name is " + this.name
			: "I don't have a name";
		console.log(greeting);
	}

	const User = mongoose.model('User', userSchema);

	const initDbGen = require('user-test-db');
	const initDb = new initDbGen({
		model: User,
		dbName: 'user',
		permissionMaster: this.permissionMaster
	});

	this.initCallback();
	return this;
};

//END OF moduleFunction() ============================================================

module.exports = moduleFunction;
//module.exports = new moduleFunction();

